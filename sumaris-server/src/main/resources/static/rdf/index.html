<!DOCTYPE html>
<!--
  #%L
  SUMARiS:: Server
  %%
  Copyright (C) 2018 SUMARiS Consortium
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU General Public
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/gpl-3.0.html>.
  #L%
  -->

<html>
<head>
    <meta charset="utf-8" />
    <title>SUMARiS - RDF test page</title>

    <link rel="stylesheet" href="/core/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/core/css/bootstrap-grid.min.css" />

    <script language="javascript" type="text/javascript">

        var restBasePath = 'api';

        var inputUri;
        var inputFormat;
        var inputModelType;
        var inputDomain;
        var inputClassName;
        var inputDisjoints;
        var inputMethods;
        var inputPackages;

        var uriDiv;
        var paramsDiv;
        var logDiv;
        var outputTextarea;

        var requests_examples = {

        };

        function init()
        {
            inputUri = document.getElementById("baseUri");
            inputUri.oninput = computeBaseUri;

            inputFormat = document.getElementById("format");
            inputFormat.onchange = computeBaseUri;

            inputModelType = document.getElementById("type");
            inputModelType.onchange = onModelTypeChanged;

            inputDomain = document.getElementById("domain");
            inputClassName = document.getElementById("className");

            inputDisjoints = document.getElementById("disjoints");
            inputDisjoints.onchange = computeParams;

            inputMethods = document.getElementById("methods");
            inputMethods.onchange = computeParams;
            inputMethods.checked = false;

            inputPackages = document.getElementById("packages");
            if (inputPackages) inputPackages.oninput = computeParams;

            uriDiv = document.getElementById("uriDiv");
            paramsDiv = paramsDiv = document.getElementById("paramsDiv");
            outputTextarea = document.getElementById("outputTextarea");
            logDiv = document.getElementById("logDiv");

            if (window.location && window.location.origin) {
                inputUri.value = window.location.origin + '/' + restBasePath + '/';
            }
            computeBaseUri();
            computeParams();
            onModelTypeChanged();
        }

        function logInfo(message, cssClass)
        {
            logToHtml(message, cssClass || 'text-info');
            console.info(message);
        }

        function logWarning(message)
        {
            logToHtml('WARNING: ', 'text-warning');
            console.warn(message);
        }

        function logError(message, error)
        {
            logToHtml('ERROR: ' + message, 'text-error');
            if (error) {
                console.error(message, error);
            }
            else {
                console.error(message);
            }
        }

        function computeBaseUri() {
            var baseUri = inputUri.value;
            if (baseUri.lastIndexOf('/') !== baseUri.length - 1) {
                baseUri += '/';
            }

            console.info("New base URI: " + baseUri);

            uriDiv.innerHTML = baseUri;

            return baseUri;
        }

        function computeParams() {
            var params = [];
            if (inputDisjoints.checked) {
                params.push('disjoints=true')
            }
            if (inputMethods.checked) {
                params.push('methods=true')
            }
            if (inputPackages && inputPackages.value) {
                params.push('packages=' + inputPackages.value)
            }
            var paramsString = (params.length) ? ('?' + params.join('&')) : '';

            paramsDiv.innerHTML = paramsString;

            return paramsString;
        }

        function onModelTypeChanged() {

            var modelType = inputModelType.value;
            console.info("Model type changed to: " + modelType);

            if (modelType === 'data') {
                inputClassName.classList.remove('d-none');
            }
            else {
                inputClassName.classList.add('d-none');
            }
        }

        function createRequestUri()
        {
            var path = computeBaseUri();

            var format = inputFormat.value || 'rdf';
            path += format + '/';

            var modelType = inputModelType.value;
            path +=  modelType + '/';

            // Add domain
            path += inputDomain.value + '/' ;

            // Add classname (if domain = data)
            if (modelType === 'data') {
                path += inputClassName.value  + '/' ;
            }

            // Add params
            path += computeParams();

            return path;
        }


        function executeRequest(requestUri) {

            requestUri = requestUri || createRequestUri();

            try {

                logInfo("GET: " + requestUri, "text-muted");
                var xmlhttp = new XMLHttpRequest();
                var now = Date.now();
                outputTextarea.value = 'Loading...';
                xmlhttp.onreadystatechange = function() {
                        if (xmlhttp.readyState == XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE == 4
                            if (xmlhttp.status == 200) {
                                var execTimeMs = Date.now() - now;
                                outputTextarea.value = xmlhttp.responseText;
                                logInfo('Response received in ' + execTimeMs + 'ms');
                            }
                            else if (xmlhttp.status == 400 || xmlhttp.status == 404) {
                                logError('Http error ' + xmlhttp.status + ' (not found)');
                            }
                            else {
                                logError('Unknown error (code=' + xmlhttp.status + ')', xmlhttp.error);
                            }
                        }
                    };

                xmlhttp.open("GET", requestUri, true);
                xmlhttp.send();

            }
            catch(error) {
                console.error(error);
                logError({data: (error && error.message || error)});
            }
        }

        function logToHtml(message, classAttribute)
        {
            var pre = document.createElement("p");
            if (classAttribute) {
                var classes = classAttribute.split(" ");
                for (var i=0; i< classes.length; i++) {
                    pre.classList.add(classes[i]);
                }
            }
            pre.style.wordWrap = "break-word";
            pre.innerHTML = message;
            logDiv.appendChild(pre);
        }

        function clearScreen()
        {
            logDiv.innerHTML = "";
            outputTextarea.value = "";
        }

        function showExample(name) {
            if (requests_examples[name]) {
                inputContent.value = JSON.stringify(requests_examples[name]);
            }
        }


        window.addEventListener("load", init, false);

    </script>
</head>
<body>
    <div class="container">

        <h1>RDF test page</h1>

        <div class="form-group">
            <label for="baseUri">Server API URL</label>
            <input type="text" name="baseUri" id="baseUri" class="form-control" placeholder="http://server/path">
        </div>

        <div class="form-group">
            <label for="baseUri">Request URL</label>

            <div class="form-inline">

                <div id="uriDiv"></div>
                <span>&nbsp;</span>

                <!-- format -->
                <select name="format" id="format">
                    <option value="rdf" selected>RDF (XML)</option>
                    <option value="json">RDF (JSON)</option>
                    <option value="vowl">VOWL</option>

                    <option value="jsonld">JSON-LD (JSON Linked data)</option>
                    <option value="ntriple">N-TRIPLE</option>
                    <option value="ttl">Turtle (TTL)</option>
                    <option value="n3">N3 (plain text)</option>
                    <option value="trig">TriG</option>
                    <option value="trix">Trix format</option>
                </select>
                <span>&nbsp;/&nbsp;</span>

                <!-- model type -->
                <select name="type" id="type">
                    <option value="ontologies" selected>Ontologies (ontologies))</option>
                    <option value="data">Ontologies &amp; data</option>
                </select>
                <span>&nbsp;/&nbsp;</span>

                <!-- model name -->
                <select name="domain" id="domain">
                    <option value="referential" selected>Referential</option>
                    <option value="data">Data</option>
                    <option value="social">Social</option>
                    <option value="technical">Technical</option>
                    <option value="vo">Value Object</option>
                </select>

                <span>&nbsp;/&nbsp;</span>

                <select name="className" id="className" class="d-none">
                    <option value="Location">Location</option>
                    <option value="Gear">Gear</option>
                    <option value="Taxon" selected>Taxon</option>
                    <option value="Transcription">Transcription</option>

                    <option value="Department">Department</option>

                    <option value="Trip">Trip</option>
                </select>
                <span>&nbsp;/</span>

                <div id="paramsDiv"></div>
            </div>
        </div>

        <div class="form-group">
            <input type="checkbox" id="disjoints" name="disjoints"
                   checked>
            <label for="disjoints">Disjoints ?</label>
            <input type="checkbox" id="methods" name="methods">
            <label for="methods">Export methods ?</label>
        </div>

        <div class="form-group text-center">
            <button type="button" onclick="clearScreen()" class="btn btn-light btn-lg ">Clear</button>
            <button type="button" onclick="executeRequest()" class="btn btn-primary btn-lg">Execute</button>
        </div>

        <div class="container">
            <div class="row">
                <!-- Output header -->
                <div class="col col-8">
                    <h2>Response:</h2>
                </div>

                <!-- Log header -->
                <div class="col col-4">
                    <h2>Log:</h2>
                </div>
            </div>

            <div class="row">
                <!-- Output -->
                <div class="col col-8">
                    <textarea name="output" id="outputTextarea" rows="30" class="form-control" placeholder="Output result"></textarea><br/>
                </div>

                <!-- Log -->
                <div class="col col-4" id="logDiv">
                </div>
            </div>
        </div>

        <script src="/core/js/jquery.slim.min.js"></script>
        <script src="/core/js/bootstrap.min.js"></script>
    </div>
</body>
